# AGGRESSIVE Performance optimization configuration for Laravel container

# CPU and I/O optimizations - AGGRESSIVE
echo "vm.swappiness = 5" >> /etc/sysctl.conf
echo "vm.dirty_ratio = 20" >> /etc/sysctl.conf
echo "vm.dirty_background_ratio = 10" >> /etc/sysctl.conf
echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf
echo "vm.overcommit_ratio = 100" >> /etc/sysctl.conf
echo "vm.max_map_count = 262144" >> /etc/sysctl.conf

# File system optimizations - AGGRESSIVE
echo "fs.file-max = 4194304" >> /etc/sysctl.conf
echo "fs.inotify.max_user_watches = 1048576" >> /etc/sysctl.conf
echo "fs.inotify.max_user_instances = 8192" >> /etc/sysctl.conf
echo "fs.inotify.max_queued_events = 16384" >> /etc/sysctl.conf

# Network performance optimizations - AGGRESSIVE
echo "net.core.rmem_default = 524288" >> /etc/sysctl.conf
echo "net.core.rmem_max = 33554432" >> /etc/sysctl.conf
echo "net.core.wmem_default = 524288" >> /etc/sysctl.conf
echo "net.core.wmem_max = 33554432" >> /etc/sysctl.conf
echo "net.core.netdev_max_backlog = 10000" >> /etc/sysctl.conf
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
echo "net.ipv4.tcp_rmem = 8192 65536 33554432" >> /etc/sysctl.conf
echo "net.ipv4.tcp_wmem = 8192 65536 33554432" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
echo "net.ipv4.tcp_slow_start_after_idle = 0" >> /etc/sysctl.conf
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
echo "net.ipv4.tcp_fin_timeout = 15" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_time = 600" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_intvl = 10" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_probes = 3" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 65535" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_tw_buckets = 2000000" >> /etc/sysctl.conf
echo "net.ipv4.ip_local_port_range = 1024 65535" >> /etc/sysctl.conf

# Apply performance optimizations
sysctl -p 2>/dev/null || true

# Optimize disk I/O scheduler - AGGRESSIVE
echo "deadline" > /sys/block/sda/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdb/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdc/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdd/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sde/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdf/queue/scheduler 2>/dev/null || true

# Set read-ahead buffer - AGGRESSIVE
echo "8192" > /sys/block/sda/queue/read_ahead_kb 2>/dev/null || true
echo "8192" > /sys/block/sdb/queue/read_ahead_kb 2>/dev/null || true
echo "8192" > /sys/block/sdc/queue/read_ahead_kb 2>/dev/null || true
echo "8192" > /sys/block/sdd/queue/read_ahead_kb 2>/dev/null || true
echo "8192" > /sys/block/sde/queue/read_ahead_kb 2>/dev/null || true
echo "8192" > /sys/block/sdf/queue/read_ahead_kb 2>/dev/null || true

# Optimize queue depths - AGGRESSIVE
echo "1024" > /sys/block/sda/queue/nr_requests 2>/dev/null || true
echo "1024" > /sys/block/sdb/queue/nr_requests 2>/dev/null || true
echo "1024" > /sys/block/sdc/queue/nr_requests 2>/dev/null || true
echo "1024" > /sys/block/sdd/queue/nr_requests 2>/dev/null || true
echo "1024" > /sys/block/sde/queue/nr_requests 2>/dev/null || true
echo "1024" > /sys/block/sdf/queue/nr_requests 2>/dev/null || true

# AGGRESSIVE PHP-FPM process manager settings
# These settings are configured in www.conf for maximum performance:
# pm.max_children = 100 (doubled from 50)
# pm.start_servers = 20 (quadrupled from 5)
# pm.min_spare_servers = 10 (doubled from 5)
# pm.max_spare_servers = 50 (increased from 35)
# pm.max_requests = 2000 (doubled from 1000)

# AGGRESSIVE nginx worker processes
# worker_processes auto; (already set in nginx.conf)
# worker_connections 2048; (doubled from 1024)
# worker_rlimit_nofile 131072; (doubled from 65535)

# AGGRESSIVE nginx gzip compression (configured in nginx.conf)
# gzip on;
# gzip_vary on;
# gzip_proxied any;
# gzip_comp_level 9; (increased from 6)

# AGGRESSIVE OPcache settings (configured in opcache.ini)
# opcache.memory_consumption = 512 (doubled from 256)
# opcache.max_accelerated_files = 40000 (doubled from 20000)
# opcache.interned_strings_buffer = 32 (doubled from 16)
# opcache.revalidate_freq = 0
# opcache.validate_timestamps = 0

# Memory optimization
echo "vm.vfs_cache_pressure = 50" >> /etc/sysctl.conf
echo "vm.page-cluster = 3" >> /etc/sysctl.conf

# CPU optimization
echo "kernel.sched_autogroup_enabled = 0" >> /etc/sysctl.conf
echo "kernel.sched_min_granularity_ns = 10000000" >> /etc/sysctl.conf
echo "kernel.sched_wakeup_granularity_ns = 15000000" >> /etc/sysctl.conf

# Apply all optimizations
sysctl -p 2>/dev/null || true
