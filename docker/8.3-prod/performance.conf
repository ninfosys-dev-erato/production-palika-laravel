# Performance optimization configuration for Laravel container

# CPU and I/O optimizations
echo "vm.swappiness = 10" >> /etc/sysctl.conf
echo "vm.dirty_ratio = 15" >> /etc/sysctl.conf
echo "vm.dirty_background_ratio = 5" >> /etc/sysctl.conf
echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf

# File system optimizations
echo "fs.file-max = 2097152" >> /etc/sysctl.conf
echo "fs.inotify.max_user_watches = 524288" >> /etc/sysctl.conf

# Network performance optimizations
echo "net.core.rmem_default = 262144" >> /etc/sysctl.conf
echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
echo "net.core.wmem_default = 262144" >> /etc/sysctl.conf
echo "net.core.wmem_max = 16777216" >> /etc/sysctl.conf
echo "net.core.netdev_max_backlog = 5000" >> /etc/sysctl.conf
echo "net.ipv4.tcp_rmem = 4096 65536 16777216" >> /etc/sysctl.conf
echo "net.ipv4.tcp_wmem = 4096 65536 16777216" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
echo "net.ipv4.tcp_slow_start_after_idle = 0" >> /etc/sysctl.conf
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
echo "net.ipv4.tcp_fin_timeout = 30" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_time = 1200" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_intvl = 15" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_probes = 5" >> /etc/sysctl.conf

# Apply performance optimizations
sysctl -p 2>/dev/null || true

# Optimize disk I/O scheduler
echo "deadline" > /sys/block/sda/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdb/queue/scheduler 2>/dev/null || true
echo "deadline" > /sys/block/sdc/queue/scheduler 2>/dev/null || true

# Set read-ahead buffer
echo "4096" > /sys/block/sda/queue/read_ahead_kb 2>/dev/null || true
echo "4096" > /sys/block/sdb/queue/read_ahead_kb 2>/dev/null || true
echo "4096" > /sys/block/sdc/queue/read_ahead_kb 2>/dev/null || true

# Optimize PHP-FPM process manager
# These settings are already configured in www.conf but can be tuned based on server resources
# pm.max_children = 50 (adjust based on available memory)
# pm.start_servers = 5
# pm.min_spare_servers = 5
# pm.max_spare_servers = 35

# Optimize nginx worker processes
# worker_processes auto; (already set in nginx.conf)
# worker_connections 1024; (already set in nginx.conf)

# Enable nginx gzip compression (already configured in nginx.conf)
# gzip on;
# gzip_vary on;
# gzip_proxied any;
# gzip_comp_level 6;

# Optimize OPcache settings (already configured in opcache.ini)
# opcache.memory_consumption = 256
# opcache.max_accelerated_files = 20000
# opcache.revalidate_freq = 0
# opcache.validate_timestamps = 0
